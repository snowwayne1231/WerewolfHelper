<template>
  <div class="page">
    <div class="page-content page-game process-{{process}} is-night-{{isNight}} has-witches-health-{{witchesHealth}} round-{{gameRound}} captain-mode-{{setting.captainMode}}">
      <div class="left-player players">
        {{#each playerLeft}}
          <div
            key="{{this.id}}"
            class="{{this.classword}}"
            data-id="{{this.id}}"
            data-killing="{{this.killing}}"
            data-killed="{{this.killed}}"
            data-iswolf="{{this.isWolf}}"
            data-guarded="{{this.guarded}}"
            data-picking="{{this.picking}}"
            @click="onClickPlayer">{{this.id}}</div>
        {{/each}}
      </div>
      <div class="right-player players">
        {{#each playerRight}}
          <div key="{{this.id}}"
            class="{{this.classword}}"
            data-id="{{this.id}}"
            data-killing="{{this.killing}}"
            data-killed="{{this.killed}}"
            data-iswolf="{{this.isWolf}}"
            data-guarded="{{this.guarded}}"
            data-picking="{{this.picking}}"
            @click="onClickPlayer">{{this.id}}</div>
        {{/each}}
      </div>

      <div id="abs-go-night" @click="onClickGoToNight">夜</div>
    </div>

    <div id="process-alert" class="process-alert">

        <a class="button yes" @click="onClickYes">O</a>
        <a class="button no" @click="onClickNo">X</a>
    </div>

    <div class="mp3s">
      <!-- <audio id="mp3player" loop="true">
        <source src="./static/music.mp3" type="audio/mpeg">
      </audio> -->
      <audio id="audio-1">
        <source src="./static/1.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-2">
        <source src="./static/2.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-2-2">
          <source src="./static/2-2.mp3" type="audio/mpeg">
        </audio>
      <audio id="audio-3">
          <source src="./static/3.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-4">
        <source src="./static/4.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-5">
        <source src="./static/5.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-6">
        <source src="./static/6.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-7">
        <source src="./static/7.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-8">
        <source src="./static/8.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-9">
        <source src="./static/9.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-10">
        <source src="./static/10.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-11">
        <source src="./static/11.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-12">
        <source src="./static/12.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-13">
        <source src="./static/13.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-14">
        <source src="./static/14.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-win">
        <source src="./static/win.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-lose">
        <source src="./static/lose.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-open">
        <source src="./static/open.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-close">
        <source src="./static/close.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-checkself">
        <source src="./static/checkself.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-roleok">
        <source src="./static/roleok.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-doskill">
        <source src="./static/doskill.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-captainvote">
        <source src="./static/captainvote.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-doublerole">
        <source src="./static/doublerole.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-peace">
        <source src="./static/peace.mp3" type="audio/mpeg">
      </audio>
      <audio id="audio-peopledead">
        <source src="./static/peopledead.mp3" type="audio/mpeg">
      </audio>
    </div>
  </div>
</template>

<script>
  import { onClickPlayerInNight, onClickPlayerInDay, onClickGoToNight } from './_game/click.functions';

  export default {
    data() {
      return {
        isNight: false,
        gameRound: 1,
        process: 0,
        playerLeft: [],
        playerRight: [],
        witchesPoison: true,
        witchesPoisonTarget: -1,
        witchesHealth: true,
        lastTimeGuard: -1,

        setting: {
          peopleNum: 9,
          roles: [],
          werewolfRoles: [],
          wolfNum: 3,
          gameEndingMode: -1,
          captainMode: -1,
        },
        hero: {},
        mp3: null,
        audio: {},
        smallGap: 3000,
        normalGap: 5000,
        largeGap: 20000,
      };
    },
    methods: {
      onClickPlayerInNight,
      onClickPlayerInDay,
      onClickGoToNight,
      onClickPlayer: function(evt) {
        const $this = this;
        const target = evt.target;
        const id = parseInt(target.dataset.id, 10);
        const killing = target.dataset.killing == 'true';
        const killed = target.dataset.killed == 'true';
        // const isLeft = id <= this.playerLeft.length;
        const app = this.$f7;

        console.log('onClickPlayer', target.dataset);

        if (this.isNight) {
          this.onClickPlayerInNight(this.process, id, killing);
        } else {
          this.onClickPlayerInDay(this.process, id, killing);
        }

      },
      onClickYes: function(evt) {
        const confirm = this.$$('#process-alert')[0];
        confirm.style.display = 'none';

        const fn = this._yes_function;

        if (fn && typeof fn === 'function') {
          fn.call(this);
        }
      },
      onClickNo: function(evt) {
        const confirm = this.$$('#process-alert')[0];
        confirm.style.display = 'none';

        const fn = this._no_function;

        if (fn && typeof fn === 'function') {
          fn.call(this);
        }
      },
      smallTip: function(text, audioKey = false, time = 0) {
        const $this = this;
        const promise = new Promise((resolve, reject) => {
          const progress = $this.$f7.dialog.progress(text);

          window.setTimeout(function(){
            progress.close();
            resolve();
          }, time || $this.smallGap);
        });
        this.playMp3(audioKey);
        return promise;
      },
      playMp3: function(key) {
        const $this = this;
        const promise = new Promise((resolve, reject) => {
          if (key && $this.audio[key]) {
            $this.audio[key].play();
          }
          window.setTimeout(function(){
            resolve();
          }, $this.smallGap);
        });
        return promise;
      },
      startNightRound: function(process) {
        let next = process;

        //巫
        if (next==2 && !this.hero[2]) {
          next = 3;
        }

        //預
        if (next==3 && !this.hero[1]) {
          next = 4;
        }

        //守
        if (next==4 && !this.hero[4]) {
          next = 6;
        }

        if (next==5 && !this.hero[5]) {
          next = 6;
        }

        //騎士
        if (next==6 && (!this.hero[6] || this.hero[6].player > 0)) {
          next = 7;
        }

        //獵人
        if (next==7 && (!this.hero[3] || this.hero[3].player > 0)) {
          next = 99;
        }

        switch (next) {
          case 0: this.smallTip('狼人請確認身分', '1').then(() => {}); break;
          case 1: this.smallTip('狼人請殺人', '2').then(() => {}); break;
          case 2: this.smallTip('女巫請睜眼', '3').then(() => {this.hero[2].player == -1 && this.playMp3('checkself')}); break;
          case 3: this.smallTip('預言家請睜眼', '5').then(() => {this.hero[1].player == -1 && this.playMp3('checkself')}); break;
          case 4: this.smallTip('守衛請睜眼', '7').then(() => {this.hero[4].player == -1 && this.playMp3('checkself')}); break;
          case 5: this.smallTip('禁言長老請睜眼', '9').then(() => {this.hero[5].player == -1 && this.playMp3('checkself')}); break;
          case 6: this.smallTip('騎士請睜眼', '11').then(() => {this.hero[6].player == -1 && this.playMp3('checkself')}); break;
          case 7: this.smallTip('獵人請睜眼', '13').then(() => {this.hero[3].player == -1 && this.playMp3('checkself')}); break;
          case 99:
          default:
            this.wakeup();
        }

        this.$setState({
          process: next,
          isNight: next < 99,
        });
      },
      wakeup: function() {

        this.smallTip('天亮了', 'open').then(() => {
          if (this.setting.captainMode==1 && this.gameRound == 1) {
            this.smallTip('現在開始警長競選', 'captainvote').then(() => {
              window.alert('結束');
              this.killPeople(0).then((isOver) => {
                this.$setState({
                  gameRound: this.gameRound +1,
                });
              });
            });
          } else {
            this.killPeople(0).then((isOver) => {
              this.$setState({
                gameRound: this.gameRound +1,
              });
            });
          }
        });

      },
      killPeople: function(mode) {
        // mode 0 = 晚上, 1 = 白天
        const death = [];
        const playerLeft = this.playerLeft.map(kill);
        const playerRight = this.playerRight.map(kill);

        this.$setState({
          playerLeft,
          playerRight,
        });


        return death.length == 0
          ? this.smallTip(`<div style="padding:${this.wpadding()};">昨天晚上是平安夜</div>`, 'peace', this.normalGap).then(() => false)
          : this.smallTip(`<div style="padding:${this.wpadding()};">玩家 [ ${death.join(',')} ] 死亡</div>`, 'null', this.normalGap).then(() => {
            const result = mode == 0 ? this.checkResult(true) : null;
            if (result == null) {
              // 獵人
              if (this.hero[3] && this.hero[3].player && death.includes(this.hero[3].player)) {
                if (this.witchesPoisonTarget != this.hero[3].player) {
                  window.alert(`玩家 [ ${this.hero[3].player} ] 可以發動技能`);
                }
              }
            }
            return result;
          });

        function kill(e) {
          e.killed = (e.killing || e.killed) && (!e.guarded || mode == 1);
          if (e.killed && e.killing) { death.push(e.id); }
          e.killing = false;
          e.guarded = false;
          if (e.killed) { e.classword = 'killed'; }
          else { e.classword = 'none'; }
          return e;
        }
      },
      checkResult: function(isWakeUp = false) {
        const allPlayer = this.playerLeft.concat(this.playerRight);
        const allAlivePlayer = allPlayer.filter(e => !e.killed);
        console.log('allPlayer []', allPlayer, allAlivePlayer);
        const wolfs = allAlivePlayer.filter(e => e.isWolf);
        const goods = allAlivePlayer.filter(e => !e.isWolf);
        let result = null;

        if (isWakeUp && wolfs.length === 0) {

          this.audio['win'].play();
          result = '好人勝利';
        } else {

          if (this.setting.gameEndingMode == 1) {
            //屠邊
            const hero_ids = Object.values(this.hero).map(e => e.player);
            const heros = goods.filter(e => hero_ids.includes(e.id));
            // console.log('heros', heros);
            const normalGoods = goods.length - heros.length;
            if (normalGoods == 0 || heros.length == 0) {
              this.audio['lose'].play();
              result = '狼人勝利';
            }
          } else {
            //城
            const goodsNum = this.witchesHealth || this.witchesPoison ? goods.length + 1 : goods.length;
            if (goodsNum <= wolfs.length) {
              this.audio['lose'].play();
              result = '狼人勝利';
            }
          }

          if (wolfs.length === 0) {
            this.audio['win'].play();
            result = '好人勝利';
          } else if (goods.length <= 2 && !isWakeUp){
            result = '狼人勝利';
          }
        }

        if (result) {
          // this.mp3.pause();
          const $this = this;
          this.result = result;
          const heroPlayerMap = {};
          Object.values(this.hero).map(e => {
            if (e.player > 0) {
              heroPlayerMap[e.player] = e.name;
            }
          });

          const templateshow = `${result}</br> ${allPlayer.map(e => {
            let godName = heroPlayerMap[e.id];
            let role = e.isWolf
              ? '狼人'
              : godName || '民';
            return e.name + ' ' + role;
          }).join('</br>')}`;
          return this.$f7.dialog.alert(templateshow, null, function(){
            $this.$router.navigate('/');
          });
        } else {

        }
        return result;
      },
      yesorno: function(yesFunc, noFunc) {
        this._yes_function = yesFunc;
        this._no_function = noFunc;
        const confirm = this.$$('#process-alert')[0];
        confirm.style.display = 'block';
      },
      pickRole: function(player_id, hero_id) {
        const isDoubleClick = this._picking_player === player_id;
        if (isDoubleClick) {

          // check this player id whether exist in wolf or hero
          if (
            Object.values(this.hero).map(e => e.player).includes(player_id) ||
            this.playerRight.map(p => p.isWolf ? p.id : -1).includes(player_id) ||
            this.playerLeft.map(p => p.isWolf ? p.id : -1).includes(player_id)
          ) {
            this.playMp3('doublerole');
            return false;
          }

          this.hero[hero_id].player = player_id;
          this._picking_player = -1;
          this._picking_hero = -1;
          if (hero_id < 5 && hero_id != 3) {
            this.playMp3('roleok').then(()=> {
              // this.playMp3('doskill');
            });
          }
        } else {

          this._picking_player = player_id;
          this._picking_hero = hero_id;
        }

        const playerLeft = this.playerLeft.map(e => {
          e.picking = e.id == player_id && !isDoubleClick; return e;
        });
        const playerRight = this.playerRight.map(e => {
          e.picking = e.id == player_id && !isDoubleClick; return e;
        });

        this.$setState({
          playerLeft,
          playerRight,
        });

        return isDoubleClick;
      },
      getPlayer: function(id) {
        let q = this.playerLeft.find(e => e.id == id);
        if (!q) q = this.playerRight.find(e => e.id == id);
        return q;
      },
      wpadding: function() {
        const law = this.playerLeft.filter(e => e.isWolf && !e.killed);
        const raw = this.playerRight.filter(e => e.isWolf && !e.killed);
        let t = 0;
        let r = 0;
        let l = 0;
        // console.log('playerLeft', law, raw);
        if (law.length == 0 || raw.length == 0) {
          t = 10;
        }
        if (law.length > raw.length) {
          r = 15;
        } else if (law.length < raw.length) {
          l = 15;
        }
        return `${t}px ${r}px 0px ${l}px`;
      },
    },
    on: {
      pageAfterIn: function () {

        let data = window.store.state.game;
        console.log('game data: ', window.store.state.game);
        if (!data || data.wolfNum == 0) {
          /*
          data = {

            peopleNum: 9,
            roles: [
              // {id: 1, name: '預言家', use: true},
              {id: 2, name: '女巫', use: true},
              // {id: 3, name: '獵人', use: true},
              // {id: 4, name: '守衛', use: true},
              // {id: 5, name: '禁言長老', use: true},
              // {id: 6, name: '騎士', use: true},
              // {id: 7, name: '白癡', use: true},
            ],
            werewolfRoles: [
              {id: 1, name: '雪狼', use: true},
              {id: 2, name: '狼王', use: true},
            ],
            wolfNum: 3,
            gameEndingMode: 1,
            captainMode: 1,
          }
          */
          return this.$router.navigate('/');
        };

        const audio = {};
        this.$$('audio').map((idx, ele) => {
          audio[ele.id.replace('audio-', '')] = ele;
        });

        const leftNum = Math.ceil(data.peopleNum / 2);
        const rightNum = data.peopleNum - leftNum;
        const hero = {};

        data.roles.map(role => {
          hero[role.id] = {
            name: role.name,
            player: -1,
          };
        });

        const playerLeft = newPlayers(leftNum, 1);

        const playerRight = newPlayers(rightNum, 1+leftNum);

        this.$setState({
          playerLeft,
          playerRight,
          hero,
          setting: data,
          audio,
        });

        const $this = this;
        // console.log($this);

        const dialog = $this.$f7.dialog.alert(
          `天黑請閉眼 [ ${1} ]`,
          null,
          function () {
            $this.playMp3('close');
            window.setTimeout(()=> {
              $this.startNightRound(0);
            }, $this.smallGap);

          }
        );

        console.log('game', this);

        function newPlayers(num, start) {
          let i = start;
          return new Array(num).fill(0).map(e => {
            const obj = {
              id: i,
              name: `[ ${i} ]`,
              killing: false,
              killed: false,
              isWolf: false,
              guarded: false,
              poisoning: false,
              classword: 'none',
            }
            i++;
            return obj;
          });
        }
      },
      // pageBeforeOut: function () {
      // },
      updated: function() {
        console.log(window.store.state);
        const state = window.store.state;
      },
    },
  }
</script>
