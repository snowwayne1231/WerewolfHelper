<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner">
        <div class="left">
          <!-- <a href="#" class="link panel-open" data-panel="left">
            <i class="icon f7-icons if-ios">menu</i>
            <i class="icon material-icons if-md">menu</i>
          </a> -->
        </div>
        <div class="title sliding">狼人殺面殺小幫手</div>
        <div class="right">
          <!-- <a href="#" class="link panel-open" data-panel="right">
            <i class="icon f7-icons if-ios">menu</i>
            <i class="icon material-icons if-md">menu</i>
          </a> -->
        </div>
      </div>
    </div>

    <!-- <div class="toolbar toolbar-bottom">
      <div class="toolbar-inner">
        <a href="#" class="link">Left Link</a>
        <a href="#" class="link">Right Link</a>
      </div>
    </div> -->
    <div class="page-content">
      <!-- <div class="block-title">Navigation</div>
      <div class="list">
        <ul>
          <li>
            <a href="/about/" class="item-content item-link">
              <div class="item-inner">
                <div class="item-title">About</div>
              </div>
            </a>
          </li>
          <li>
            <a href="/form/" class="item-content item-link">
              <div class="item-inner">
                <div class="item-title">Form</div>
              </div>
            </a>
          </li>
        </ul>
      </div> -->
      <div class="block-title">遊戲</div>
      <div class="block block-strong">
        <div class="row">
          <div class="col-100">
            <a href="/game-setting" class="button button-fill button-raised item-link">創建遊戲</a>
            <a href="/game-join" class="button button-fill button-raised item-link">加入遊戲</a>
          </div>
        </div>

      </div>
      <!-- <div class="list">
        <ul>
          <li>
            <a href="/dynamic-route/blog/45/post/125/?foo=bar#about" class="item-link item-content">
              <div class="item-inner">
                <div class="item-title">Dynamic Route</div>
              </div>
            </a>
          </li>
        </ul>
      </div> -->
    </div>
  </div>
</template>
<script>
  import Vue from 'vue';
  import Vuex from 'vuex';
  Vue.use(Vuex);

  const initGame = {
    roomId: -1,
    isNight: false,
    round: 1,
    process: 0,
    playerLeft: [],
    playerRight: [],
    witchesPoison: true,
    witchesPoisonTarget: -1,
    witchesHealth: true,
    lastTimeGuard: -1,

    roles: [
        {id: 1, name: '預言家', use: true},
        {id: 2, name: '女巫', use: true},
    ],
    werewolfRoles: [],
    wolfNum: 3,
    peopleNum: 10,
    gameEndingMode: 2,
    captainMode: 2,
    hero: {},
  }

  const store = new Vuex.Store({
    state: {
      game: initGame,

    },
    actions: {
        GAME_RESTART ({commit}) {
            commit('UPDATE:GAME', initGame);
        },
        GAME_SETTING ({commit}, setting) {
            commit('UPDATE:GAME', setting);
        },
        GAME_CREATE_ROOM ({state, commit}) {
            console.log('GAME_CREATE_ROOM');
            send({
                type: 'create',
                setting: {
                    roles: state.game.roles,
                    werewolfRoles: state.game.werewolfRoles,
                    wolfNum: state.game.wolfNum,
                    peopleNum: state.game.peopleNum,
                    gameEndingMode: state.game.gameEndingMode,
                    captainMode: state.game.captainMode,
                    hero: state.game.hero,
                },
            });
        },
    },
    mutations: {
        'UPDATE:GAME': (state, input) => {
            const next = {...state.game};
            Object.keys(input).map((key) => {
                next[key] = input[key];
            });
            state.game = next;
        },
    },
  });

  window.store = store;

  console.log('init', window.store, window.app, window.socket);

    window.socket.on('message', onMessage);

    function send(obj) {
        console.log('send!!', obj);
        console.log('window.socket!!', window.socket.connected);
        window.socket.emit('message', JSON.stringify(obj));
    }

    function onMessage(json) {
        const type = json.type || '';
        const payload = json.payload;

        switch(type) {
            case 'create':
                store.dispatch('GAME_SETTING', {roomId: payload})
            default:
        }
    }


    export default {}
</script>
